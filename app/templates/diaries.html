<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quote Diary â€” ë‘ í˜ì´ì§€ ë‹¤ì´ì–´ë¦¬</title>
  <style>
    :root{
      --paper:#faf7ef; --paper2:#fffdf7; --line:#d6d0c6; --ink:#2b2b2b;
      --muted:#6b6b6b; --shadow:rgba(0,0,0,.12); --accent:#0a4b5c;
      --red:#b83a3a; --green:#1c7c54; --pin:#b64e37; --note:#fff6a9;
      --danger:#d54d4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#e9e3d8; color:var(--ink);
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Pretendard, Apple SD Gothic Neo, sans-serif;
      letter-spacing:.1px;
    }

    .wrap{min-height:100%; display:grid; place-items:center; padding:32px 16px}
    .book{
      position:relative; width:min(1120px,96vw); background:#d7c9b6; border-radius:18px;
      box-shadow:inset 0 0 0 2px rgba(0,0,0,.05), 0 22px 50px var(--shadow);
      padding:18px;
    }
    .spine{
      position:absolute; top:0; bottom:0; left:50%; width:20px; transform:translateX(-50%);
      background:repeating-linear-gradient(#2a2a2a 0 12px,#565656 12px 24px);
      border-left:2px solid rgba(255,255,255,.25); border-right:2px solid rgba(0,0,0,.25);
      z-index:2;
    }

    .spread{
      display:grid; grid-template-columns:1fr 1fr; gap:0; position:relative; z-index:1;
      border-radius:14px;
    }
    .page{
      background:
        repeating-linear-gradient(#0000,#0000 28px, rgba(0,0,0,.06) 29px, #0000 30px),
        var(--paper);
      padding:26px 24px 28px;
      min-height:620px;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.08);
      position:relative;
    }
    .left{
      background:
        repeating-linear-gradient(#0000,#0000 28px, rgba(0,0,0,.06) 29px, #0000 30px),
        var(--paper2);
      border-right:1.5px dashed rgba(0,0,0,.15);
      overflow:hidden;
    }
    .right{
      background:
        repeating-linear-gradient(#0000,#0000 28px, rgba(0,0,0,.06) 29px, #0000 30px),
        var(--paper);
      border-left:1.5px dashed rgba(0,0,0,.15);
    }

    .holes{
      position:absolute; left:10px; top:46px; display:flex; flex-direction:column; gap:110px;
    }
    .holes span{
      width:10px; height:10px; border-radius:50%; background:#2a2a2a;
      box-shadow:0 1px 0 rgba(255,255,255,.4) inset; opacity:.65;
    }

    /* ì™¼ìª½ í—¤ë” */
    .head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:0 0 8px;
    }
    .head-left{display:flex; gap:10px; align-items:center;}
    .head h2{ margin:0; font-size:22px; letter-spacing:.2px }
    .toolbar{ color:var(--muted); font-size:14px; display:flex; align-items:center; gap:10px }
    .toolbar .link{ all:unset; color:var(--accent); cursor:pointer; text-decoration:underline }
    .toolbar .logout{ all:unset; color:var(--red); cursor:pointer; text-decoration:underline; }
    .search-box input{
      border:1px solid rgba(0,0,0,.15);
      border-radius:999px;
      padding:5px 10px;
      font-size:13px;
      background:#fffefb;
      width:140px;
    }

    /* ëª©ë¡ */
    .list{
      display:grid; grid-template-columns: 1.3fr .9fr; gap:8px 12px;
      align-items:start; font-size:15px; line-height:1.35;
      max-height:calc(100% - 140px); overflow:auto; padding-right:4px;
    }
    .list .th{ color:#5a5a5a; font-weight:700; position:sticky; top:0; background:linear-gradient(#fffefb,#fffefb);
               padding:4px 0; border-bottom:1px dashed #bbb; }
    .row{ cursor:pointer; padding:6px 4px; border-radius:6px; display:flex; align-items:center; gap:6px; }
    .row:hover{ background:rgba(0,0,0,.05) }
    .muted{ color:var(--muted) }

    /* í¬ìŠ¤íŠ¸ì‡ ìˆëŠ” ë‹¤ì´ì–´ë¦¬ í‘œì‹œ */
    .row.has-note-title{ color:var(--danger); font-weight:600; }
    .row .badge{
      display:inline-block;
      background:rgba(213,77,77,.14);
      color:var(--danger);
      font-size:11px;
      padding:2px 5px;
      border-radius:6px;
    }
    .row .toggle-note{
      font-size:11px;
      color:#0a4b5c;
      text-decoration:underline;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ë„¤ë¹„ */
    .nav-wrap{
      position:absolute; left:18px; right:18px; bottom:10px; display:flex; justify-content:space-between; align-items:center;
      font-family: "Nanum Pen Script", cursive; font-size:18px;
    }
    .scribble{ all:unset; cursor:pointer; text-decoration:underline; color:#0a4b5c; padding:2px 6px }
    .page-no{ color:#666; font-size:16px }

    /* ì˜¤ë¥¸ìª½ ë¬¸ì„œ */
    .doc h3{ margin:0 0 4px; font-size:24px; display:flex; align-items:center; gap:8px }
    .date{ color:var(--muted); font-size:14px; margin-bottom:8px; text-align:right }
    .content{
      white-space:pre-wrap; line-height:1.6; font-size:17px; min-height:160px;
      border:1px solid rgba(0,0,0,.03); border-radius:10px; padding:10px 12px;
      background:rgba(255,255,255,.45);
    }
    .doc-actions{
      display:flex; gap:8px; margin:6px 0 12px;
    }
    .btn-sm{
      border:none; border-radius:6px; padding:5px 10px;
      background:#0a4b5c; color:white; cursor:pointer; font-size:13px;
    }
    .btn-danger{
      background:#c43b3b; color:#fff;
    }

    /* ì˜¤ë¥¸ìª½ í¬ìŠ¤íŠ¸ì‡ */
    .note{
      position:absolute; right:18px; bottom:18px; width:220px; min-height:140px; padding:14px 14px 36px;
      background: var(--note);
      border:1px solid #e4d470; border-radius:8px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18), inset 0 2px 0 rgba(255,255,255,.4);
      transform: rotate(1.2deg);
      user-select:none; touch-action:none; display:none;
      z-index:20;
    }
    .note.show{ display:block }
    .note.bookmarked{ border:2px solid #d54d4d; box-shadow:0 12px 22px rgba(213,77,77,.35); }
    .note .pin{
      position:absolute; width:12px; height:12px; border-radius:50%; background:var(--pin);
      top:8px; left:8px; box-shadow:0 2px 0 rgba(0,0,0,.25);
    }
    .note .txt{ white-space:pre-wrap; line-height:1.35; font-size:14px; color:#3b2b21; }
    .note .author{ margin-top:6px; font-size:12px; color:#5a4a3d }
    .note .controls{
      position:absolute; right:8px; bottom:6px; display:flex; gap:6px; font-size:13px;
    }
    .note .btn{ all:unset; cursor:pointer; color:#513b2a; padding:2px 6px; border-radius:6px; background:#f8e98f; border:1px solid #e2d276 }
    .note .btn:hover{ filter:brightness(1.05) }

    .bookmark-btn{
      all:unset;
      position:absolute;
      top:6px;
      right:6px;
      background:white;
      border:1px solid rgba(0,0,0,.1);
      border-radius:999px;
      padding:1px 8px 0;
      font-size:13px;
      cursor:pointer;
    }
    .bookmark-btn.active{
      background:#d54d4d;
      color:white;
      border-color:#b43737;
    }

    /* ì˜¤ë¥¸ìª½ í•˜ë‹¨ ë¶ë§ˆí¬ ë¦¬ìŠ¤íŠ¸ */
    .bookmark-panel{
      margin-top:14px;
      border-top:1px dashed #c9c0b4;
      padding-top:10px;
    }
    .bookmark-panel h4{
      margin:0 0 8px;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .bookmark-list{
      max-height:120px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:5px;
      font-size:13px;
    }
    .bookmark-item{
      background:#fffefb;
      border:1px solid rgba(0,0,0,.03);
      border-radius:6px;
      padding:4px 6px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:center;
    }
    .bookmark-item small{color:#7a6f5a;}
    .bookmark-remove{
      all:unset;
      font-size:12px;
      color:#d54d4d;
      cursor:pointer;
    }

    /* ìƒˆ ì¼ê¸° ëª¨ë‹¬ */
    .floating-form{
      position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; z-index:999;
    }
    .floating-form .card{
      background:#fffdf8; border:1px solid rgba(0,0,0,.085); border-radius:12px; width:min(420px, 94vw);
      padding:16px 16px 14px; box-shadow:0 20px 40px rgba(0,0,0,.28);
    }
    .floating-form h3{ margin:0 0 10px; }
    .floating-form label{ display:block; font-size:13px; margin-bottom:4px; }
    .floating-form input,
    .floating-form textarea{
      width:100%; border:1px solid #d0c5b6; border-radius:8px; padding:8px 10px; font-size:14px; font-family:inherit;
    }
    .floating-form textarea{ min-height:120px; resize:vertical; }
    .floating-form .actions{ margin-top:10px; display:flex; gap:8px; justify-content:flex-end; }
    .floating-form button{ border:none; border-radius:7px; padding:6px 12px; cursor:pointer; }
    .floating-form .primary{ background:#0a4b5c; color:white; }
    .floating-form .ghost{ background:transparent; }

    @media (max-width:860px){
      .spread{ grid-template-columns:1fr }
      .right{ border-left:none; border-top:1.5px dashed rgba(0,0,0,.15) }
      .note{ position:fixed; right:12px; bottom:12px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <section class="book">
    <div class="spine" aria-hidden="true"></div>

    <div class="spread">
      <!-- ì™¼ìª½ í˜ì´ì§€ -->
      <section class="page left" id="left-page">
        <div class="holes" aria-hidden="true"><span></span><span></span><span></span></div>

        <div class="head">
          <div class="head-left">
            <h2>ë‹¤ì´ì–´ë¦¬</h2>
            <div class="search-box">
              <input id="search" type="text" placeholder="ê²€ìƒ‰..." />
            </div>
          </div>
          <div class="toolbar">
            <span class="link" id="new">ìƒˆ ì¼ê¸°</span>
            <span class="link" id="refresh">ìƒˆë¡œê³ ì¹¨</span>
            <span class="logout" id="logout">ë¡œê·¸ì•„ì›ƒ</span>
          </div>
        </div>

        <div class="list" id="list">
          <div class="th">ì œëª©</div>
          <div class="th" style="text-align:right">ë‚ ì§œ</div>
        </div>

        <div class="nav-wrap">
          <button class="scribble" id="prev">&lt; Prev</button>
          <span class="page-no" id="pageNo">1 / 1</span>
          <button class="scribble" id="next">Next &gt;</button>
        </div>
      </section>

      <!-- ì˜¤ë¥¸ìª½ í˜ì´ì§€ -->
      <section class="page right" id="right-page">
        <div class="holes" aria-hidden="true" style="left:auto; right:10px;"><span></span><span></span><span></span></div>

        <div class="doc" id="doc">
          <h3>
            <span id="doc-title" class="empty">ì œëª©</span>
          </h3>
          <div class="date" id="doc-date">ë‚ ì§œ</div>

          <div class="doc-actions">
            <button class="btn-sm" id="edit-btn">ìˆ˜ì •</button>
            <button class="btn-sm btn-danger" id="delete-btn">ì‚­ì œ</button>
          </div>

          <div class="content" id="doc-content">ì™¼ìª½ì—ì„œ ì¼ê¸°ë¥¼ ê³ ë¥´ê±°ë‚˜ â€œìƒˆ ì¼ê¸°â€ë¥¼ ëˆŒëŸ¬ì¤˜ ë•ƒ.</div>

          <!-- ğŸ”¥ ë¶ë§ˆí¬ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ -->
          <div class="bookmark-panel" id="bookmark-panel">
            <h4>ë¶ë§ˆí¬í•œ ëª…ì–¸ <small class="muted">(ì´ ê¸°ê¸°)</small></h4>
            <div class="bookmark-list" id="bookmark-list">
              <div class="empty">ì•„ì§ ë¶ë§ˆí¬í•œ ëª…ì–¸ì´ ì—†ë•ƒ.</div>
            </div>
          </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ í¬ìŠ¤íŠ¸ì‡ -->
        <div class="note" id="note" aria-label="ëœë¤ ëª…ì–¸ í¬ìŠ¤íŠ¸ì‡">
          <span class="pin" aria-hidden="true"></span>
          <button class="bookmark-btn" id="bookmark-btn">â™¥</button>
          <div class="txt" id="note-text">ì—¬ê¸°ì— ëª…ì–¸ì´ ëœ¬ë‹¤ë•ƒ.</div>
          <div class="author" id="note-author"></div>
          <div class="controls">
            <button class="btn" id="note-shuffle">â†»</button>
            <button class="btn" id="note-close">âœ•</button>
          </div>
        </div>
      </section>
    </div>
  </section>
</div>

<!-- ìƒˆ ì¼ê¸° / ìˆ˜ì • ê³µìš© ëª¨ë‹¬ -->
<div class="floating-form" id="form-modal" aria-hidden="true">
  <div class="card">
    <h3 id="form-title">ìƒˆ ì¼ê¸°</h3>
    <label for="f-title">ì œëª©</label>
    <input id="f-title" type="text" placeholder="ì˜¤ëŠ˜ì˜ ë¬¸ì¥" />
    <label for="f-content" style="margin-top:8px;">ë‚´ìš©</label>
    <textarea id="f-content" placeholder="ë‚´ìš©ì„ ì ëŠ”ê±°ì‹œë•ƒ."></textarea>
    <div class="actions">
      <button class="ghost" id="f-cancel">ì·¨ì†Œ</button>
      <button class="primary" id="f-save">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* ===== ê³µí†µ Auth ===== */
function authHeaders(extra){
  const token = localStorage.getItem('access_token');
  return Object.assign({'Content-Type':'application/json'}, token? {'Authorization':'Bearer '+token}:{}, extra||{});
}

/* ===== ìƒíƒœ ===== */
let cache = [];
let filtered = [];
const pageSize = 10;
let page = 1; let total = 1;
let currentId = null;
let editingId = null;

/* í¬ìŠ¤íŠ¸ì‡ ê´€ë ¨ (ëª…ì–¸) */
let currentQuoteId = null;
const localBookmarkKey = 'quote-bookmarks';

/* ===== DOM ===== */
const list = document.getElementById('list');
const pageNo = document.getElementById('pageNo');
const docTitle = document.getElementById('doc-title');
const docDate = document.getElementById('doc-date');
const docContent = document.getElementById('doc-content');
const searchBox = document.getElementById('search');

const formModal = document.getElementById('form-modal');
const fTitle = document.getElementById('f-title');
const fContent = document.getElementById('f-content');
const fSave = document.getElementById('f-save');
const fCancel = document.getElementById('f-cancel');
const formTitle = document.getElementById('form-title');

const editBtn = document.getElementById('edit-btn');
const deleteBtn = document.getElementById('delete-btn');
const logoutBtn = document.getElementById('logout');

const bookmarkListBox = document.getElementById('bookmark-list');

/* ===== ë¡œê·¸ì•„ì›ƒ ===== */
logoutBtn.addEventListener('click', async ()=>{
  const token = localStorage.getItem('access_token');
  if(!token){
    window.location.href = '/auth';
    return;
  }
  try{
    await fetch('/auth/logout', {
      method:'POST',
      headers: authHeaders()
    });
  }catch(e){}
  localStorage.removeItem('access_token');
  window.location.href = '/auth';
});

/* ===== ëª©ë¡ ë¡œë“œ ===== */
async function loadList(){
  let res;
  try{
    res = await fetch('/diaries/list', { headers: authHeaders() });
  }catch(e){
    list.innerHTML = '<div class="empty">ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ë•ƒ.</div>';
    return;
  }

  if(res.status === 401){
    window.location.href = '/auth'; return;
  }

  const data = await res.json().catch(()=>[]);
  if(!res.ok){
    list.innerHTML = `<div class="empty">ëª©ë¡ ì‹¤íŒ¨: ${data?.detail||res.status}</div>`;
    return;
  }

  data.sort((a,b)=>{
    const at = a.updated_at || a.created_at;
    const bt = b.updated_at || b.created_at;
    return new Date(bt) - new Date(at);
  });

  cache = data;
  filtered = data.slice();
  page = 1;
  total = Math.max(1, Math.ceil(filtered.length / pageSize));
  renderList();
  updatePager();

  if(filtered.length > 0){
    showDetail(filtered[0].id);
  }else{
    showEmptyDetail();
  }
}

/* ===== ëª©ë¡ ë Œë” ===== */
function renderList(){
  list.innerHTML = `
    <div class="th">ì œëª©</div>
    <div class="th" style="text-align:right">ë‚ ì§œ</div>
  `;

  const start = (page-1)*pageSize;
  const end = Math.min(start+pageSize, filtered.length);
  for(let i=start;i<end;i++){
    const d = filtered[i];

    const a = document.createElement('div'); a.className='row';
    const b = document.createElement('div'); b.className='row'; b.style.textAlign='right';

    const hasNote = hasNoteForDiary(d.id);

    // ì œëª© ìª½ ë‚´ìš©
    if(hasNote){
      a.classList.add('has-note-title');
      a.innerHTML = `
        <span>${d.title || '(ì œëª© ì—†ìŒ)'}</span>
        <span class="badge">í¬ìŠ¤íŠ¸ì‡</span>
        <span class="toggle-note" data-id="${d.id}">í¬ìŠ¤íŠ¸ì‡ë„ê¸°</span>
      `;
    }else{
      a.innerHTML = `
        <span>${d.title || '(ì œëª© ì—†ìŒ)'}</span>
        <span class="toggle-note" data-id="${d.id}">í¬ìŠ¤íŠ¸ì‡</span>
      `;
    }

    b.textContent = formatDate(d.updated_at || d.created_at);

    // ì œëª© í´ë¦­ â†’ ìƒì„¸ ì—´ê¸°
    a.addEventListener('click', ()=> showDetail(d.id));
    b.addEventListener('click', ()=> showDetail(d.id));

    list.appendChild(a); list.appendChild(b);
  }

  // í¬ìŠ¤íŠ¸ì‡ í† ê¸€ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ë¶™ì´ê¸°
  list.querySelectorAll('.toggle-note').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();  // ì œëª© ì—´ê¸° ë§‰ê¸°
      const id = Number(btn.dataset.id);
      toggleDiaryNote(id);
    });
  });
}

function updatePager(){ pageNo.textContent = `${page} / ${total}`; }
document.getElementById('prev').onclick = ()=>{ if(page>1){ page--; renderList(); updatePager(); } };
document.getElementById('next').onclick = ()=>{ if(page<total){ page++; renderList(); updatePager(); } };
document.getElementById('refresh').onclick = loadList;

/* ===== ê²€ìƒ‰ ===== */
searchBox.addEventListener('input', ()=>{
  const q = searchBox.value.trim().toLowerCase();
  if(!q){
    filtered = cache.slice();
  }else{
    filtered = cache.filter(d=>{
      return (d.title && d.title.toLowerCase().includes(q)) ||
             (d.content && d.content.toLowerCase().includes(q));
    });
  }
  page = 1;
  total = Math.max(1, Math.ceil(filtered.length / pageSize));
  renderList();
  updatePager();
});

/* ===== ìƒì„¸ ===== */
async function showDetail(id){
  let res;
  try{
    res = await fetch(`/diaries/${id}`, { headers: authHeaders() });
  }catch(e){
    docTitle.textContent='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
    docTitle.classList.remove('empty');
    return;
  }

  if(res.status === 401){
    window.location.href = '/auth'; return;
  }

  const d = await res.json().catch(()=>null);
  if(!res.ok || !d){
    docTitle.textContent='ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
    docTitle.classList.remove('empty');
    return;
  }

  currentId = d.id;
  docTitle.textContent = d.title || '(ì œëª© ì—†ìŒ)';
  docTitle.classList.remove('empty');
  docDate.textContent = formatDate(d.updated_at || d.created_at);
  docContent.textContent = d.content || '';

  restoreNoteForCurrent();
}

/* ë¹ˆ ìƒì„¸ */
function showEmptyDetail(){
  currentId = null;
  docTitle.textContent = 'ì¼ê¸° ì—†ìŒ';
  docDate.textContent = '';
  docContent.textContent = 'â€œìƒˆ ì¼ê¸°â€ë¥¼ ëˆŒëŸ¬ì„œ í•˜ë‚˜ ì‘ì„±í•˜ëŠ”ê±°ì‹œë•ƒ.';
  hideNote();
}

/* ===== ìƒˆ ì¼ê¸° ëª¨ë‹¬ ===== */
document.getElementById('new').addEventListener('click', ()=>{
  editingId = null;
  formTitle.textContent = 'ìƒˆ ì¼ê¸°';
  fTitle.value = '';
  fContent.value = '';
  formModal.style.display = 'flex';
  fTitle.focus();
});
fCancel.addEventListener('click', ()=>{
  formModal.style.display = 'none';
});
fSave.addEventListener('click', async ()=>{
  const title = fTitle.value.trim();
  const content = fContent.value.trim();
  if(!title){
    alert('ì œëª©ì€ ìˆì–´ì•¼ í•˜ëŠ”ê±°ì‹œë•ƒ.');
    return;
  }

  if(!editingId){
    let res;
    try{
      res = await fetch('/diaries/', {
        method:'POST',
        headers: authHeaders(),
        body: JSON.stringify({ title, content })
      });
    }catch(e){
      alert('ì„œë²„ ì˜¤ë¥˜'); return;
    }
    if(res.status === 401){ window.location.href = '/auth'; return; }
    if(!res.ok){
      const err = await res.json().catch(()=>({}));
      alert(err.detail || 'ì‘ì„± ì‹¤íŒ¨'); return;
    }
  }else{
    let res;
    try{
      res = await fetch(`/diaries/${editingId}`, {
        method:'PUT',
        headers: authHeaders(),
        body: JSON.stringify({ title, content })
      });
    }catch(e){
      alert('ì„œë²„ ì˜¤ë¥˜'); return;
    }
    if(res.status === 401){ window.location.href = '/auth'; return; }
    if(!res.ok){
      const err = await res.json().catch(()=>({}));
      alert(err.detail || 'ìˆ˜ì • ì‹¤íŒ¨'); return;
    }
  }

  formModal.style.display = 'none';
  await loadList();
});

/* ===== ìˆ˜ì • ë²„íŠ¼ ===== */
editBtn.addEventListener('click', ()=>{
  if(!currentId) return;
  formTitle.textContent = 'ì¼ê¸° ìˆ˜ì •';
  fTitle.value = docTitle.textContent === 'ì œëª©' ? '' : docTitle.textContent;
  fContent.value = docContent.textContent === 'ì™¼ìª½ì—ì„œ ì¼ê¸°ë¥¼ ê³ ë¥´ê±°ë‚˜ â€œìƒˆ ì¼ê¸°â€ë¥¼ ëˆŒëŸ¬ì¤˜ ë•ƒ.' ? '' : docContent.textContent;
  editingId = currentId;
  formModal.style.display = 'flex';
  fTitle.focus();
});

/* ===== ì‚­ì œ ë²„íŠ¼ ===== */
deleteBtn.addEventListener('click', async ()=>{
  if(!currentId) return;
  if(!confirm('ì •ë§ ì‚­ì œí• ê¹Œ ë•ƒ?')) return;
  let res;
  try{
    res = await fetch(`/diaries/${currentId}`, {
      method:'DELETE',
      headers: authHeaders()
    });
  }catch(e){
    alert('ì„œë²„ ì˜¤ë¥˜'); return;
  }
  if(res.status === 401){ window.location.href = '/auth'; return; }
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    alert(err.detail || 'ì‚­ì œ ì‹¤íŒ¨'); return;
  }
  localStorage.removeItem(`postit:${currentId}`);
  await loadList();
});

/* ===== í¬ìŠ¤íŠ¸ì‡(ëœë¤ ëª…ì–¸) ===== */
const note = document.getElementById('note');
const noteText = document.getElementById('note-text');
const noteAuthor = document.getElementById('note-author');
const noteShuffle = document.getElementById('note-shuffle');
const noteClose = document.getElementById('note-close');
const bookmarkBtn = document.getElementById('bookmark-btn');

async function loadRandomQuote(){
  try{
    const res = await fetch('/quotes/random_quote', { headers: authHeaders() });
    const q = await res.json();
    if(res.ok){
      currentQuoteId = q.id;
      noteText.textContent = q.content || '(ë‚´ìš© ì—†ìŒ)';
      noteAuthor.textContent = q.author ? `â€” ${q.author}` : '';
      note.classList.add('show');

      const bookmarked = isQuoteBookmarked(q.id);
      renderBookmarkState(bookmarked);

      persistNote({content:noteText.textContent, author:noteAuthor.textContent, visible:true});
      renderList();
    }else{
      noteText.textContent = 'ëª…ì–¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆë•ƒ.'; noteAuthor.textContent='';
    }
  }catch{
    noteText.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë•ƒâ€¦'; noteAuthor.textContent='';
  }
}

noteShuffle.addEventListener('click', loadRandomQuote);
noteClose.addEventListener('click', ()=>{
  hideNote();
  persistNote({visible:false});
  renderList();
});

function hideNote(){
  note.classList.remove('show');
  note.classList.remove('bookmarked');
}

/* í¬ìŠ¤íŠ¸ì‡ ì €ì¥/ë³µêµ¬ */
function noteKey(id){
  const diaryId = typeof id === 'number' ? id : currentId;
  return diaryId ? `postit:${diaryId}` : null;
}
function persistNote(patch, id){
  const key = noteKey(id); if(!key) return;
  const cur = JSON.parse(localStorage.getItem(key) || '{}');
  const state = Object.assign(cur, patch);
  localStorage.setItem(key, JSON.stringify(state));
}
function hasNoteForDiary(id){
  const st = JSON.parse(localStorage.getItem(`postit:${id}`) || '{}');
  return !!st.visible;
}
function restoreNoteForCurrent(){
  const key = noteKey(); if(!key) return;
  const st = JSON.parse(localStorage.getItem(key) || '{}');
  if(st.content){ noteText.textContent = st.content; noteAuthor.textContent = st.author || ''; }
  note.classList.toggle('show', !!st.visible);
  renderList();
}

/* ğŸ”¥ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë°”ë¡œ í¬ìŠ¤íŠ¸ì‡ í† ê¸€í•  ë•Œ ì“°ëŠ” í•¨ìˆ˜ */
function toggleDiaryNote(diaryId){
  const key = noteKey(diaryId);
  const st = JSON.parse(localStorage.getItem(key) || '{}');
  const willShow = !st.visible;

  // í˜„ì¬ ë³´ê³  ìˆëŠ” ì¼ê¸°ë©´ í¬ìŠ¤íŠ¸ì‡ DOMë„ í† ê¸€
  if(currentId === diaryId){
    if(willShow){
      // í¬ìŠ¤íŠ¸ì‡ ì—´ ë•ŒëŠ” ëª…ì–¸ ìƒˆë¡œ ë½‘ì•„ë„ ë˜ê³ , ì €ì¥ëœ ë‚´ìš© ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ
      if(st.content){
        noteText.textContent = st.content;
        noteAuthor.textContent = st.author || '';
        note.classList.add('show');
      }else{
        // ìƒˆë¡œ ë½‘ì
        loadRandomQuote();
      }
    }else{
      hideNote();
    }
  }

  persistNote({visible:willShow}, diaryId);
  renderList();
}

/* ===== ëª…ì–¸ ë¶ë§ˆí¬ ===== */
function getLocalBookmarks(){
  return JSON.parse(localStorage.getItem(localBookmarkKey) || '[]');
}
function saveLocalBookmarks(list){
  localStorage.setItem(localBookmarkKey, JSON.stringify(list));
}
function isQuoteBookmarked(id){
  const list = getLocalBookmarks();
  return list.includes(id);
}
function renderBookmarkState(active){
  if(active){
    bookmarkBtn.classList.add('active');
    note.classList.add('bookmarked');
  }else{
    bookmarkBtn.classList.remove('active');
    note.classList.remove('bookmarked');
  }
}

/* ë¶ë§ˆí¬ ë¦¬ìŠ¤íŠ¸ ë Œë” */
function renderBookmarkList(){
  const list = getLocalBookmarks();
  bookmarkListBox.innerHTML = '';
  if(list.length === 0){
    bookmarkListBox.innerHTML = '<div class="empty">ì•„ì§ ë¶ë§ˆí¬í•œ ëª…ì–¸ì´ ì—†ë•ƒ.</div>';
    return;
  }
  list.forEach(id=>{
    const item = document.createElement('div');
    item.className = 'bookmark-item';
    item.innerHTML = `
      <div>
        <strong>#${id}</strong>
        <small>â€” ë¶ë§ˆí¬ëœ ëª…ì–¸</small>
      </div>
      <button class="bookmark-remove" data-id="${id}">ì‚­ì œ</button>
    `;
    bookmarkListBox.appendChild(item);
  });

  bookmarkListBox.querySelectorAll('.bookmark-remove').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = Number(e.target.getAttribute('data-id'));
      const cur = getLocalBookmarks().filter(x=>x !== id);
      saveLocalBookmarks(cur);
      renderBookmarkList();
      if(currentQuoteId === id){
        renderBookmarkState(false);
      }
    });
  });
}

bookmarkBtn.addEventListener('click', async ()=>{
  if(!currentQuoteId) return;
  try{
    const res = await fetch(`/quotes/${currentQuoteId}/bookmark`, {
      method:'POST',
      headers: authHeaders()
    });
    if(res.status === 401){ window.location.href = '/auth'; return; }
    if(res.ok){
      const list = getLocalBookmarks();
      if(!list.includes(currentQuoteId)){
        list.push(currentQuoteId);
        saveLocalBookmarks(list);
      }
      renderBookmarkState(true);
      renderBookmarkList();
    }else{
      alert('ë¶ë§ˆí¬ ì‹¤íŒ¨í–ˆë•ƒ.');
    }
  }catch(e){
    alert('ì„œë²„ì™€ í†µì‹  ì‹¤íŒ¨í–ˆë•ƒ.');
  }
});

/* ===== ìœ í‹¸ ===== */
function formatDate(x){ try{ return new Date(x).toLocaleString(); }catch{return x||'';} }

/* ===== init ===== */
(async ()=>{
  await loadList();
  renderBookmarkList();
})();
</script>
</body>
</html>
